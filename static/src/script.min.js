let apiUrl;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){apiUrl="/data"}else{apiUrl="https://your-deployed-domain.com/data"}const RUN_ID="{{ run_id }}";let currentPaginationPage=1;$(document).ready(function(){const storedRunId=localStorage.getItem("runId");if(storedRunId!==RUN_ID){console.log("New run detected, clearing local storage...");localStorage.clear();sessionStorage.clear();localStorage.setItem("runId",RUN_ID)}fetchData();$("#csv-selector, #page-size").change(function(){currentPaginationPage=1;fetchData()});$("body").on("click",".page-link",function(e){e.preventDefault();const page=$(this).data("page");currentPaginationPage=page;fetchData(page)})});document.addEventListener("DOMContentLoaded",function(){const refreshButton=document.getElementById("refresh-data");refreshButton.addEventListener("click",function(){clearCurrentPageCache();fetchData(currentPaginationPage)})});function clearCurrentPageCache(){const selectedFile=$("#csv-selector").val();const pageSize=parseInt($("#page-size").val(),10);const cacheKey=generateCacheKey(selectedFile,currentPaginationPage,pageSize);sessionStorage.removeItem(cacheKey);console.log(`Cache cleared for key: ${cacheKey}`)}async function fetchData(page=currentPaginationPage){const selectedFile=$("#csv-selector").val();const pageSize=parseInt($("#page-size").val(),10);const cacheKey=generateCacheKey(selectedFile,page,pageSize);let data;try{data=sessionStorage.getItem(cacheKey);if(!data){showLoadingIndicator();const response=await fetch(`${apiUrl}?file_id=${selectedFile}&page=${page}&page_size=${pageSize}`);if(!response.ok){console.error("Failed to load data");return}data=await response.json();try{sessionStorage.setItem(cacheKey,JSON.stringify(data));console.log(`Data cached for key: ${cacheKey}`)}catch(e){if(isQuotaExceeded(e)){console.warn("Storage limit reached. Not caching this data.",e)}else{console.error("Error caching data:",e)}}}else{data=JSON.parse(data);console.log(`Using cached data for key: ${cacheKey}`)}updatePagination(data.currentPage,data.totalPages);await updateTable(data.data,data.currentPage,data.pageSize)}catch(error){console.error("Error fetching or processing data:",error)}finally{hideLoadingIndicator()}}async function fetchDataAsync(){try{await fetchData()}catch(error){console.error("Error in fetchData:",error)}}function generateCacheKey(fileId,page,pageSize){return`parquetData-${RUN_ID}-${fileId}-${page}-${pageSize}`}function updateTable(data,currentPage,pageSize){return new Promise(resolve=>{const tableBody=$("#data-rows");tableBody.empty();data.forEach(function(row,index){const tr=$("<tr>");const rowIndex=(currentPage-1)*pageSize+(index+1);const formattedRowIndex=rowIndex.toLocaleString();tr.append(`<td>${formattedRowIndex}</td>`);tr.append(`<td>${row["question"]}</td>`);if(row["long_answers"].trim()){tr.append(`<td>${row["long_answers"]}</td>`)}else{tr.append(`<td></td>`)}if(row["short_answers"].trim()){tr.append(`<td>${row["short_answers"]}</td>`)}else{tr.append("<td></td>")}tableBody.append(tr)});resolve()})}function updatePagination(currentPage,totalPages){console.log("pagination construction started");const paginationContainer=$(".pagination");paginationContainer.empty();paginationContainer.append(`<li class="page-item ${currentPage===1?"disabled":""}"><a class="page-link" href="#" data-page="1">First</a></li>`);paginationContainer.append(`<li class="page-item ${currentPage===1?"disabled":""}"><a class="page-link" href="#" data-page="${currentPage-1}">Previous</a></li>`);let startPage=Math.max(currentPage-2,1);let endPage=startPage+4;if(endPage>totalPages){endPage=totalPages;startPage=Math.max(endPage-4,1)}for(let i=startPage;i<=endPage;i++){paginationContainer.append(`<li class="page-item ${i===currentPage?"active":""}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`)}paginationContainer.append(`<li class="page-item ${currentPage===totalPages?"disabled":""}"><a class="page-link" href="#" data-page="${currentPage+1}">Next</a></li>`);paginationContainer.append(`<li class="page-item ${currentPage===totalPages?"disabled":""}"><a class="page-link" href="#" data-page="${totalPages}">Last</a></li>`)}function showLoadingIndicator(){$("#table-overlay").show();$("#loading-indicator").show();simulateProgressBar()}function hideLoadingIndicator(){$("#table-overlay").hide();$("#loading-indicator").hide();$("#loading-indicator .progress-bar").css("width","0%").attr("aria-valuenow",0)}let progressInterval;function simulateProgressBar(){clearInterval(progressInterval);let progress=0;progressInterval=setInterval(function(){progress+=10;if(progress<=100){$("#loading-indicator .progress-bar").css("width",progress+"%").attr("aria-valuenow",progress)}else{clearInterval(progressInterval)}},100)}function isQuotaExceeded(e){let quotaExceeded=false;if(e){if(e.code){switch(e.code){case 22:quotaExceeded=true;break;case 1014:if(e.name==="NS_ERROR_DOM_QUOTA_REACHED"){quotaExceeded=true}break}}else if(e.number===-2147024882){quotaExceeded=true}}return quotaExceeded}